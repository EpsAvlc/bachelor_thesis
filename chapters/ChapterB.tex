% !Mode:: "TeX:UTF-8"

\chapter{三维感知传感器机构设计}
为了能够解决低线数激光雷达在障碍物检测问题上由于点云的稀疏性而造成的困难，本章提出了一种三维感知传感器机构，通过增加三维激光雷达在垂直方向的往复旋转，同时融合多帧激光点云，来增加激光雷达在铅垂方向上的分辨率，实现类似于高线数激光雷达的稠密点云。

\section{三维感知传感器机构的机械结构设计}
\begin{pics}[htbp]{机构总图}{structure_all}
    \addsubpic{solidworks渲染图}{width=0.5\textwidth}{structure_sw}
    \addsubpic{实物图}{width=0.6\textwidth}{structure}
\end{pics}
\subsection{机械结构运动原理}
本章所述的机构结构如图\ref{structure}所示，其中3508电机提供驱动转矩，曲柄连杆装置将电机的旋转运动转化为激光雷达底座在航向角(yaw)方向上的往复运动，同时绝对值磁编码器记录激光雷达在航向角上的角度变化，以供多传感器融合时使用。

在著名的激光SLAM算法LOAM\citeup{zhang2014loam}中，由于当时的条件限制，其文章作者没有三维激光雷达来进行SLAM，而是用一个舵机给一个二维激光雷达进行竖直方向的往复旋转来增加线数，如图\ref{loam}所示。
\pic[htbp]{LOAM中的机构设计}{width=0.4\textwidth}{loam}

该机构最大的优点就是结构简单，这也是本文初次采用的机构设计。然而该机构有以下几个缺点：
\begin{enumerate}
    \item 在往复运动中，当运动方向发生改变时，由于舵机控制精度的问题，很难做到平滑换向，并且经常伴随有较大的震动，给之后的传感器融合算法带来了困难。
    \item LOAM中采用的是二位激光雷达，重量较轻，而本文需要带动三维激光雷达进行往复运动，重量较重（近1kg），长时间使用舵机带动会使舵机产生较为明显的回程间隙，影响角度的测量与后续的传感器融合的效果。
\end{enumerate}

因为上述原因，我们没有采用这种结构设计，而是采用了之前提到的曲柄连杆机构来针对三维激光雷达进行往复运动，相较于上述机构，曲柄连杆结构有以下几个优点：
\begin{enumerate}
    \item 换向平滑。执行电机只需要一直向同一方向旋转，曲柄连杆机构就能够自动换向，并且输出的角度曲线近似正弦曲线。
    \item 对执行机构负担小。仅需要较小并且较为恒定的转矩就能够驱动较大的负载做往复运动。
    \item 对执行机构的控制要求低。在该机构中，无刷电机只需要输出恒定的转矩就能够完成三维激光雷达在偏航角方向上的往复运动，并且经过验证，其角度输出近似正弦曲线，而若采用上述的舵机机构，要想得到相近的角度曲线，则对舵机的软件控制提出了较高的要求。
\end{enumerate}

综上，本文选择曲柄连杆机构作为该机构的驱动机构。

\subsection{曲柄连杆机构的设计}
该三维感知机构的一个难点在于如何设计与电机相连的曲柄连杆机构。这里参照《机械设计基础》\citeup{wang2007jixieshejijichu}一书中的相应章节对曲柄四连杆机构的连杆长度进行求解。

\pic[htbp]{四杆机构的数学模型}{width=0.4\textwidth}{crank}
如图\ref{crank}所示，假设已知该铰链四杆机构两连架杆$AB$和$CD$所形成的角度$\psi_1$和$\phi_1$在三个不同位置下的角度，要求连杆a、b、c、d的尺寸。则根据向量向x、y轴投影，有

$$a\cos\phi + b\cos\delta = d + \cos\phi$$
$$a\sin\phi + b\sin\delta = c\sin\phi$$

将上两式先进行移项，然后作平方和相加，从中消去$\delta$后整理有

$$b^2 = a^2 + c^2 + d^2 + 2cd\cos\psi -2ad\cos\phi -2ac\cos(\phi - \psi)$$

我们设
$$ 
\begin{cases}
R_1=(a^2 + d^2 + c^2 - b^2) \\
R_2=d/c \\
R_3=d/a
\end{cases}
$$

代入，则上一个式子可以化简为
$$ R_1-R_2\cos\phi + R_3\cos\psi=cos(\phi-\psi)$$
这个式子即为铰链四连杆机构的角位置方程，该方程有三个待定参数$R_1$、$R_2$、$R_3$。故应有三组对应的$\psi_1$和$\phi_1$角才能得出这个方程的解。将三组$\psi_1$和$\phi_1$角代入求解该方程后，可以得到四个构件之间的长度关系为

$$ 
\begin{cases}
a = d / R_3 \\
c = d / R_2 \\
b = \sqrt{a^2 + c^2 + d^2 -2acR_1}
\end{cases}
$$

则根据机构的具体设置情况，知道$a,b,c,d$中的任何一条边的长度后，便可知剩下四条边的长度。

在实际设计中，我们已知$\psi_1$和$\phi_1$的三组对应角度为
$$ 
\begin{cases}
\psi_1=30\circ \ \phi_1=36.3\circ\\
\psi_1=60\circ \ \phi_1=43.87\circ\\
\psi_1=120\circ \  \phi_1=35.75\circ
\end{cases}
$$
并且根据我们的机构设置，构件$d$的长度为105.72mm。将这些已知量代入公式中可得
$$ 
\begin{cases}
a=31.6mm \\
b=49.18mm \\
c=108.37mm \\
\end{cases}
$$
由此，便得到了曲柄机构的连杆构件设计参数。

\section{三维感知传感器机构的电路设计}

\begin{pics}[htbp]{驱动器与传感器}{sensors}
    \addsubpic{C620 电调}{width=0.2\textwidth}{modulation}
    \addsubpic{M3508无刷电机}{width=0.15\textwidth}{3508}
    \addsubpic{磁编码器}{width=0.2\textwidth}{encoder}
    \addsubpic{RM A型开发板}{width=0.2\textwidth}{dev_board}
\end{pics}

\subsection{驱动器}
该三维感知机构采用的驱动器为DJI C620电调，如图\ref{modulation}所示。该电调支持50-500Hz的PWM（脉宽调制）信号控制以及CAN总线指令控制，最高支持20A的持续电流，支持对CAN总线上的电调快速设置ID，支持通过CAN总线获取电机温度、转子位置和转子速度等信息，切换电机时可无需进行位置传感器的参数校准。

\subsection{执行机构}
该三维感知机构采用的执行机构为DJI M3508无刷电机，如图\ref{3508}所示。该电机可搭配上文所述C620电调实现正弦驱动，相比传统方波驱动具有更高的效率、机动性和稳定性。其最高可持续输出力矩为2.8Nm，满足驱动曲柄四连杆机构的需求。
\subsection{传感器}

\subsubsection{角度传感器}
该三维感知机构采用的角度传感器为傲蓝13线磁编码器，如图\ref{encoder}所示。该编码器采用RS485方式通信，其单圈分辨率为8192cpr, 精度为$\pm 0.1$度。

该编码器为绝对值式编码器，其相对于增量式编码器不同点在于，增量式编码器以上电时的位置为零点，每次使用都要机械对位；而绝对值式编码器能够记录机构的唯一位置，即单圈内编码器的每一个示值，都唯一对应了空间中机构的位置与角度。考虑到我们曲柄连杆机构的特性，显然绝对值式编码器更加符合我们的要求。

\subsubsection{激光雷达}
\pic[htbp]{速腾16线激光雷达}{width=0.4\textwidth}{robosense}
该三维感知机构采用的激光雷达为速腾聚创的RS-LiDAR-16，如图\ref{robosense}所示。该激光雷达为16线激光雷达，其测距范围为50cm-150m，精度误差为$\pm 2cm$。垂直视场角为30度，其角分辨率为2度；水平视场角为360度，其角分辨率为0.09-0.36度（对应的点云频率为5Hz-20Hz）。

\subsection{主控板}
该三维感知机构采用的主控板为DJI Robomaster A型开发板，如图\ref{dev_board}所示。该开发板具备类型丰富的接口，包括12V、5V、3.3V电源接口、CAN接口、UART接口、可变电压PWM接口、SWD接口等。同时该开发板拥有电源输入的防反接、过压保护、缓启动、12V电源输出过流保护、PWM端口的ESD等多重保护。

\subsection{电路拓扑}
\pic[htbp]{电路拓扑}{width=1\textwidth}{circuit}
该三维感知机构的电路拓扑如图\ref{circuit}所示。激光雷达通过千兆网接口将点云传输到mini PC上，磁编码器通过485转USB与mini PC通信，同时主控通过PWM控制电调输出，调节M3508电机的转速，M3508电机提供曲柄四连杆机构的驱动力矩，而磁编码器又将曲柄机构作用在激光雷达底座上的旋转通过485通信输出到mini PC。

\section{三维感知传感器机构的软件设计与运动控制}

根据上文所述的机械设计以及电路设计，该三维感知机构的软件设计主要实现了以下几个任务：

\begin{enumerate}
    \item 实现了各个传感器、主控到Mini　PC的通信，同时将数据以ROS（Robot Operating System）话题的方式发布出去，以供第二章节提到的多帧融合算法使用。
    \item 实现了电机的多档调速功能。为了应对不同的场景，在主控中实现了多档调速功能，以调节曲柄机构的往复运动频率。
    \item 实时检测电调的温度信息，提供了基于温度检测的堵转保护（温度过高自动切断控制）。
\end{enumerate}

此外，本文还记录了在电机输出恒定转速情况下的曲柄连杆机构的输出的角度信息，如图\ref{angles}所示。该图纵坐标为角度制的输出角度。从图中可以看出，本章所设计的三维感知机构其输出角度近似正弦曲线，并且没有较大的换向震动，相比起上文所提到的舵机的结构拥有稳定可靠的优势。

\pic[htbp]{曲柄连杆机构输出角度}{width=0.6\textwidth}{angles}

\section{本章小结}

本章提出了一种新的三维感知机构，并从该机构的机械设计、电路设计以及软件设计和运动控制三个方面介绍了该机构。在机械方面，本文提出使用无刷电机$+$曲柄摇杆机构来代替简单的舵机给三维激光雷达提供一个竖直航向角方向上的往复运动，这种结构的优势在于机构换向流畅、控制简单以及对机构负载小，能够为本文后续章节提到的激光雷达的多帧融合提供结构上的稳定与可靠性。在电路方面，本章利用绝对值式磁编码器对曲柄机构运动的角度进行了记录与输出，相较于增量式编码器，磁编码器不需要保证每次上电时机构都在同一个位置，为机械结构的设计提供了便利。在软件方面，本章实现了各个传感器与主控以及mini PC的通信，主控对无刷电机的多档控制以及对电机的堵转保护，并且绘制了输出角度，验证了机构的可行性。本文的后续章节将利用该机构输出的点云信息以及角度信息来进行点云的多帧融合稠密化，并且在融合的点云上进行三维障碍物的检测与分类。